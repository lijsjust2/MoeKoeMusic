name: Docker Build and Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: moekoemusic
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=sha,prefix={{sha}}-

      - name: Build Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: false
          load: true
          tags: moekoemusic:latest
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Get current date
        id: date
        run: |
          CURRENT_DATE=$(date +'%Y%m%d%H%M')
          echo "CURRENT_DATE=$CURRENT_DATE" >> $GITHUB_ENV

      - name: Save Docker image as tar
        run: |
          mkdir -p release-assets
          docker save -o release-assets/moekoemusic-${{ env.CURRENT_DATE }}.tar moekoemusic:latest
          echo "IMAGE_FILENAME=moekoemusic-${{ env.CURRENT_DATE }}.tar" >> $GITHUB_ENV

      - name: Create Release and Upload Asset
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const assetPath = 'release-assets/${{ env.IMAGE_FILENAME }}';
            const assetName = '${{ env.IMAGE_FILENAME }}';
            const currentDate = '${{ env.CURRENT_DATE }}';
            const tagName = 'img-${currentDate}';
            const releaseName = 'Docker Image ${currentDate}';
            const commitSha = '${{ github.sha }}';
            
            // Check if tag already exists
            let tagExists = false;
            try {
              await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/${tagName}`
              });
              tagExists = true;
            } catch (error) {
              if (error.status !== 404) throw error;
            }
            
            // Create tag if it doesn't exist
            if (!tagExists) {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/${tagName}`,
                sha: commitSha
              });
            }
            
            // Check if release already exists
            let release;
            try {
              const existingReleases = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              release = existingReleases.data.find(r => r.tag_name === tagName);
            } catch (error) {
              console.error('Error checking existing releases:', error);
            }
            
            // Create release if it doesn't exist
            if (!release) {
              release = await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tagName,
                name: releaseName,
                body: `Docker image for commit ${commitSha}`,
                draft: false,
                prerelease: false
              });
            }
            
            // Upload asset
            const assetContent = fs.readFileSync(assetPath);
            const assetSize = fs.statSync(assetPath).size;
            
            await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.data.id,
              name: assetName,
              data: assetContent,
              headers: {
                'content-type': 'application/x-tar',
                'content-length': assetSize
              }
            });
            
            console.log('Release created and asset uploaded successfully!')