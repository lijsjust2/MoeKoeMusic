name: Docker Build and Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: all

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        id: buildx
        with:
          platforms: linux/amd64,linux/arm64

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: moekoemusic
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=sha,prefix={{sha}}-

      - name: Build Docker image for amd64 architecture
        uses: docker/build-push-action@v4
        with:
          context: .
          push: false
          load: true
          platforms: linux/amd64
          tags: moekoemusic:latest-amd64
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # Use QEMU for cross-platform builds
          builder: ${{ steps.buildx.outputs.name }}

      - name: Build Docker image for arm64 architecture
        uses: docker/build-push-action@v4
        with:
          context: .
          push: false
          load: true
          platforms: linux/arm64
          tags: moekoemusic:latest-arm64
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # Use QEMU for cross-platform builds
          builder: ${{ steps.buildx.outputs.name }}

      - name: Get current date
        id: date
        run: |
          CURRENT_DATE=$(date +'%Y%m%d%H%M')
          echo "CURRENT_DATE=$CURRENT_DATE" >> $GITHUB_ENV

      - name: Save Docker images as tar files
        run: |
          mkdir -p release-assets
          docker save -o release-assets/moekoemusic-${{ env.CURRENT_DATE }}-amd64.tar moekoemusic:latest-amd64
          docker save -o release-assets/moekoemusic-${{ env.CURRENT_DATE }}-arm64.tar moekoemusic:latest-arm64
          echo "IMAGE_FILENAME_AMD64=moekoemusic-${{ env.CURRENT_DATE }}-amd64.tar" >> $GITHUB_ENV
          echo "IMAGE_FILENAME_ARM64=moekoemusic-${{ env.CURRENT_DATE }}-arm64.tar" >> $GITHUB_ENV

      - name: Create Release and Upload Assets
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const currentDate = '${{ env.CURRENT_DATE }}';
            const tagName = `img-${currentDate}`;
            const releaseName = `Docker Image ${currentDate}`;
            const commitSha = '${{ github.sha }}';
            
            // 定义镜像文件信息
            const assets = [
              {
                path: 'release-assets/${{ env.IMAGE_FILENAME_AMD64 }}',
                name: '${{ env.IMAGE_FILENAME_AMD64 }}'
              },
              {
                path: 'release-assets/${{ env.IMAGE_FILENAME_ARM64 }}',
                name: '${{ env.IMAGE_FILENAME_ARM64 }}'
              }
            ];
            
            // Check if tag already exists
            let tagExists = false;
            try {
              await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/${tagName}`
              });
              tagExists = true;
            } catch (error) {
              if (error.status !== 404) throw error;
            }
            
            // Create tag if it doesn't exist
            if (!tagExists) {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/${tagName}`,
                sha: commitSha
              });
            }
            
            // Check if release already exists
            let release;
            try {
              const existingReleases = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              release = existingReleases.data.find(r => r.tag_name === tagName);
            } catch (error) {
              console.error('Error checking existing releases:', error);
            }
            
            // Create release if it doesn't exist
            if (!release) {
              release = await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tagName,
                name: releaseName,
                body: `Docker images for commit ${commitSha}`,
                draft: false,
                prerelease: false
              });
            }
            
            // Upload all assets
            for (const asset of assets) {
              console.log(`Uploading ${asset.name}...`);
              const assetContent = fs.readFileSync(asset.path);
              const assetSize = fs.statSync(asset.path).size;
              
              try {
                await github.rest.repos.uploadReleaseAsset({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: release.data.id,
                  name: asset.name,
                  data: assetContent,
                  headers: {
                    'content-type': 'application/x-tar',
                    'content-length': assetSize
                  }
                });
                console.log(`${asset.name} uploaded successfully!`);
              } catch (error) {
                console.error(`Error uploading ${asset.name}:`, error);
                throw error;
              }
            }
            
            console.log('All assets uploaded successfully!')